{% extends 'base.html' %}
{% load l10n %}

{% block title %}Optimierungsergebnisse - {{ event.name }} - Running Dinner{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'events:organizer_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'events:manage_event' event_id=event.id %}">{{ event.name }}</a></li>
                    <li class="breadcrumb-item active">Optimierungsergebnisse</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold">
                        <i class="bi bi-diagram-3 text-success"></i>
                        Optimierungsergebnisse
                    </h1>
                    <p class="lead text-muted">{{ event.name }} - {{ optimization_run.completed_at|date:"d.m.Y H:i" }}</p>
                </div>
                <div>
                    <button class="btn btn-success btn-lg me-2" data-bs-toggle="modal" data-bs-target="#sendEmailsModal">
                        <i class="bi bi-envelope"></i> E-Mails senden
                    </button>
                    <a href="{% url 'events:manage_event' event_id=event.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Zur√ºck
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-people display-4 mb-2"></i>
                    <h3 class="fw-bold">{{ stats.total_teams }}</h3>
                    <p class="mb-0">Teams zugewiesen</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white">
                <div class="card-body text-center">
                    <i class="bi bi-geo-alt display-4 mb-2"></i>
                    <h3 class="fw-bold">{{ stats.avg_distance }} km</h3>
                    <p class="mb-0">√ò Entfernung pro Team</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="bi bi-speedometer2 display-4 mb-2"></i>
                    <h3 class="fw-bold">{{ stats.avg_preference_score }}%</h3>
                    <p class="mb-0">√ò Pr√§ferenz-Score</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle display-4 mb-2"></i>
                    <h3 class="fw-bold">{{ stats.total_distance }} km</h3>
                    <p class="mb-0">Gesamtentfernung</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Weitere Optimierung & Progress Bereich -->
    {% if user.is_staff or user.is_superuser %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">üîß Optimierung-Tools</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#additionalOptimizationModal">
                                üîÑ Weitere Optimierung
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleProgressView()">
                                üìä Progress anzeigen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress-Anzeige (standardm√§√üig ausgeblendet) -->
                    <div id="progressSection" style="display: none;">
                        <div class="progress mb-2" style="height: 20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <p id="currentTask" class="mb-2 small text-muted">Keine aktive Optimierung</p>
                        
                        <!-- Ausklappbare Logs -->
                        <div class="accordion" id="progressAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="logsHeader">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#logsCollapse" aria-expanded="false" aria-controls="logsCollapse">
                                        üìã Live Logs
                                    </button>
                                </h2>
                                <div id="logsCollapse" class="accordion-collapse collapse" aria-labelledby="logsHeader" 
                                     data-bs-parent="#progressAccordion">
                                    <div class="accordion-body">
                                        <div id="optimizationLogs" class="small" style="max-height: 200px; overflow-y: auto; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 3px;">
                                            <div class="text-muted">Keine Logs verf√ºgbar</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Course Overview Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <ul class="nav nav-tabs card-header-tabs" id="courseTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="hosting-tab" data-bs-toggle="tab" data-bs-target="#hosting" type="button" role="tab">
                                <i class="bi bi-house"></i> Hosting-√úbersicht
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="appetizer-tab" data-bs-toggle="tab" data-bs-target="#appetizer" type="button" role="tab">
                                <i class="bi bi-cup-hot"></i> Vorspeise
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="main-course-tab" data-bs-toggle="tab" data-bs-target="#main-course" type="button" role="tab">
                                <i class="bi bi-egg-fried"></i> Hauptgang
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="dessert-tab" data-bs-toggle="tab" data-bs-target="#dessert" type="button" role="tab">
                                <i class="bi bi-cup"></i> Nachspeise
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="routes-tab" data-bs-toggle="tab" data-bs-target="#routes" type="button" role="tab">
                                <i class="bi bi-map"></i> Team-Routen
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map" type="button" role="tab">
                                <i class="bi bi-geo-alt"></i> Karte
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="courseTabContent">
                        <!-- Hosting Overview -->
                        <div class="tab-pane fade show active" id="hosting" role="tabpanel">
                            <div class="row g-4">
                                {% for course, hosts in hosting_overview.items %}
                                <div class="col-md-4">
                                    <div class="card border-0 bg-light">
                                        <div class="card-header bg-primary text-white text-center">
                                            <h6 class="mb-0">
                                                {% if course == 'appetizer' %}
                                                <i class="bi bi-cup-hot"></i> Vorspeise
                                                ({{ event.appetizer_time|time:"H:i" }} Uhr)
                                                {% elif course == 'main_course' %}
                                                <i class="bi bi-egg-fried"></i> Hauptgang
                                                ({{ event.main_course_time|time:"H:i" }} Uhr)
                                                {% else %}
                                                <i class="bi bi-cup"></i> Nachspeise
                                                ({{ event.dessert_time|time:"H:i" }} Uhr)
                                                {% endif %}
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% for host_info in hosts %}
                                            <div class="mb-3 p-3 border rounded bg-white">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="bi bi-house-fill text-primary me-2"></i>
                                                    <strong>{{ host_info.host.name }}</strong>
                                                </div>
                                                <div class="small text-muted mb-2">
                                                    <i class="bi bi-geo-alt"></i> {{ host_info.host.address }}
                                                </div>
                                                <div class="small">
                                                    <strong>G√§ste:</strong>
                                                    {% for guest in host_info.guests %}
                                                    <span class="badge bg-secondary me-1">{{ guest.name }}</span>
                                                    {% empty %}
                                                    <span class="text-muted">Keine G√§ste</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% empty %}
                                            <p class="text-muted text-center">Keine Hosts f√ºr diesen Kurs</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Appetizer Tab -->
                        <div class="tab-pane fade" id="appetizer" role="tabpanel">
                            {% include 'events/partials/course_assignments.html' with assignments=assignments_by_course.appetizer course='appetizer' course_name='Vorspeise' event=event %}
                        </div>

                        <!-- Main Course Tab -->
                        <div class="tab-pane fade" id="main-course" role="tabpanel">
                            {% include 'events/partials/course_assignments.html' with assignments=assignments_by_course.main_course course='main_course' course_name='Hauptgang' event=event %}
                        </div>

                        <!-- Dessert Tab -->
                        <div class="tab-pane fade" id="dessert" role="tabpanel">
                            {% include 'events/partials/course_assignments.html' with assignments=assignments_by_course.dessert course='dessert' course_name='Nachspeise' event=event %}
                        </div>

                        <!-- Routes Tab -->
                        <div class="tab-pane fade" id="routes" role="tabpanel">
                            <div class="row g-3">
                                {% for assignment in assignments %}
                                <div class="col-lg-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-people"></i>
                                                {{ assignment.team.name }}
                                                <span class="badge bg-secondary ms-2">
                                                    {% if assignment.course == 'appetizer' %}Vorspeise-Host
                                                    {% elif assignment.course == 'main_course' %}Hauptgang-Host
                                                    {% else %}Nachspeise-Host{% endif %}
                                                </span>
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="small">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="bi bi-cup-hot"></i> Vorspeise:</span>
                                                    <span>
                                                        {% if assignment.hosts_appetizer %}
                                                        bei {{ assignment.hosts_appetizer.name }} ({{ assignment.distance_to_appetizer }} km)
                                                        {% else %}
                                                        <strong>Selbst hosting</strong>
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="bi bi-egg-fried"></i> Hauptgang:</span>
                                                    <span>
                                                        {% if assignment.hosts_main_course %}
                                                        bei {{ assignment.hosts_main_course.name }} ({{ assignment.distance_to_main_course }} km)
                                                        {% else %}
                                                        <strong>Selbst hosting</strong>
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="bi bi-cup"></i> Nachspeise:</span>
                                                    <span>
                                                        {% if assignment.hosts_dessert %}
                                                        bei {{ assignment.hosts_dessert.name }} ({{ assignment.distance_to_dessert }} km)
                                                        {% else %}
                                                        <strong>Selbst hosting</strong>
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between">
                                                    <strong>Gesamtentfernung:</strong>
                                                    <strong class="text-primary">{{ assignment.total_distance }} km</strong>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <strong>Pr√§ferenz-Score:</strong>
                                                    <strong class="text-success">{{ assignment.preference_score }}%</strong>
                                                </div>
                                            </div>
                                            
                                            <!-- Manual Adjustment Button -->
                                            <div class="mt-3">
                                                <button class="btn btn-outline-warning btn-sm w-100" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#adjustModal{{ assignment.id }}">
                                                    <i class="bi bi-pencil"></i> Manuell anpassen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Map Tab -->
                        <div class="tab-pane fade" id="map" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="card border-0">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-geo-alt"></i>
                                                Team-Standorte und Routen
                                            </h6>
                                        </div>
                                        <div class="card-body p-0">
                                            <div id="map-container" style="height: 500px; width: 100%;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="card border-0 bg-light">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle"></i>
                                                Legende
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="me-2" style="width: 20px; height: 20px; background-color: #e74c3c; border-radius: 50%; border: 2px solid white;"></div>
                                                    <span><strong>Vorspeise-Hosts</strong></span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="me-2" style="width: 20px; height: 20px; background-color: #f39c12; border-radius: 50%; border: 2px solid white;"></div>
                                                    <span><strong>Hauptgang-Hosts</strong></span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="me-2" style="width: 20px; height: 20px; background-color: #27ae60; border-radius: 50%; border: 2px solid white;"></div>
                                                    <span><strong>Nachspeise-Hosts</strong></span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="me-2" style="width: 20px; height: 20px; background-color: #3498db; border-radius: 50%; border: 2px solid white;"></div>
                                                    <span><strong>Nur G√§ste</strong></span>
                                                </div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="me-2" style="width: 25px; height: 25px; background-color: #8e44ad; border-radius: 4px; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">üè†</div>
                                                    <span><strong>Gastk√ºchen</strong></span>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2" style="width: 30px; height: 30px; background-color: #e74c3c; border-radius: 50%; border: 3px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">üéâ</div>
                                                    <span><strong>Afterparty</strong></span>
                                                </div>
                                            </div>
                                            
                                            <hr>
                                            
                                            <div>
                                                <h6 class="mb-2">Karten-Steuerung</h6>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="showRoutes" checked>
                                                    <label class="form-check-label" for="showRoutes">
                                                        Routen anzeigen
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="showLabels" checked>
                                                    <label class="form-check-label" for="showLabels">
                                                        Team-Namen anzeigen
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <hr>
                                            
                                            <div>
                                                <h6 class="mb-2">Statistiken</h6>
                                                <small class="text-muted">
                                                    <div class="d-flex justify-content-between">
                                                        <span>Teams:</span>
                                                        <strong>{{ stats.total_teams }}</strong>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <span>√ò Entfernung:</span>
                                                        <strong>{{ stats.avg_distance }} km</strong>
                                                    </div>
                                                    <div class="d-flex justify-content-between">
                                                        <span>Max. Entfernung:</span>
                                                        <strong id="max-distance">- km</strong>
                                                    </div>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Emails Modal -->
<div class="modal fade" id="sendEmailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">E-Mails an Teams senden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>M√∂chten Sie allen Teams ihre Zuweisungen und Routen per E-Mail zusenden?</p>
                <div class="alert alert-info">
                    <strong>{{ stats.total_teams }} Teams</strong> erhalten eine E-Mail mit:
                    <ul class="mb-0 mt-2">
                        <li>Ihrer Hosting-Rolle ({{ event.get_status_display }})</li>
                        <li>Adressen und Zeiten der anderen Kurse</li>
                        <li>Kontaktdaten ihrer Gastgeber</li>
                        <li>Spezielle Hinweise (Allergien, etc.)</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <form method="post" action="{% url 'events:send_team_emails' event_id=event.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-envelope"></i> E-Mails senden
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Manual Adjustment Modals -->
{% for assignment in assignments %}
<div class="modal fade" id="adjustModal{{ assignment.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ assignment.team.name }} anpassen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'events:adjust_assignment' event_id=event.id assignment_id=assignment.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Hosting-Kurs</label>
                        <select class="form-select" name="course">
                            <option value="appetizer" {% if assignment.course == 'appetizer' %}selected{% endif %}>Vorspeise</option>
                            <option value="main_course" {% if assignment.course == 'main_course' %}selected{% endif %}>Hauptgang</option>
                            <option value="dessert" {% if assignment.course == 'dessert' %}selected{% endif %}>Nachspeise</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Vorspeise bei</label>
                        <select class="form-select" name="hosts_appetizer">
                            <option value="">-- Selbst hosting --</option>
                            {% for other_assignment in assignments %}
                            {% if other_assignment.team != assignment.team %}
                            <option value="{{ other_assignment.team.id }}" 
                                    {% if assignment.hosts_appetizer == other_assignment.team %}selected{% endif %}>
                                {{ other_assignment.team.name }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Hauptgang bei</label>
                        <select class="form-select" name="hosts_main_course">
                            <option value="">-- Selbst hosting --</option>
                            {% for other_assignment in assignments %}
                            {% if other_assignment.team != assignment.team %}
                            <option value="{{ other_assignment.team.id }}" 
                                    {% if assignment.hosts_main_course == other_assignment.team %}selected{% endif %}>
                                {{ other_assignment.team.name }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Nachspeise bei</label>
                        <select class="form-select" name="hosts_dessert">
                            <option value="">-- Selbst hosting --</option>
                            {% for other_assignment in assignments %}
                            {% if other_assignment.team != assignment.team %}
                            <option value="{{ other_assignment.team.id }}" 
                                    {% if assignment.hosts_dessert == other_assignment.team %}selected{% endif %}>
                                {{ other_assignment.team.name }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
let map = null;
let teamMarkers = [];
let routeLines = [];

// Team-Daten - sicher generiert
const teamData = [
{% for assignment in assignments %}
    {
        "id": {{ assignment.team.id }},
        "name": "{{ assignment.team.name|escapejs }}",
        "address": "{{ assignment.team.home_address|default:'M√ºnchen'|escapejs }}",
        "course": "{{ assignment.course }}",
        "lat": {% if assignment.team.latitude %}{{ assignment.team.latitude|unlocalize }}{% else %}{% cycle "48.1351" "48.1365" "48.1378" "48.1392" "48.1405" "48.1418" "48.1425" "48.1432" "48.1445" "48.1458" "48.1471" "48.1484" %}{% endif %},
        "lng": {% if assignment.team.longitude %}{{ assignment.team.longitude|unlocalize }}{% else %}{% cycle "11.5820" "11.5835" "11.5850" "11.5865" "11.5880" "11.5895" "11.5910" "11.5925" "11.5940" "11.5955" "11.5970" "11.5985" %}{% endif %},
        "totalDistance": {% if assignment.total_distance %}{{ assignment.total_distance|unlocalize }}{% else %}0{% endif %},
        "preferenceScore": {% if assignment.preference_score %}{{ assignment.preference_score|unlocalize }}{% else %}0{% endif %},
        "hosts": {
            "appetizer": {% if assignment.hosts_appetizer %}"{{ assignment.hosts_appetizer.name|escapejs }}"{% else %}null{% endif %},
            "main_course": {% if assignment.hosts_main_course %}"{{ assignment.hosts_main_course.name|escapejs }}"{% else %}null{% endif %},
            "dessert": {% if assignment.hosts_dessert %}"{{ assignment.hosts_dessert.name|escapejs }}"{% else %}null{% endif %}
        }
    }{% if not forloop.last %},{% endif %    }
{% endfor %}
];

// Gastk√ºchen-Daten
const guestKitchensData = [
{% for kitchen in event.guest_kitchens.all %}
    {
        "id": {{ kitchen.id }},
        "name": "{{ kitchen.name|escapejs }}",
        "lat": {% if kitchen.latitude %}{{ kitchen.latitude|unlocalize }}{% else %}48.1574{% endif %},
        "lng": {% if kitchen.longitude %}{{ kitchen.longitude|unlocalize }}{% else %}11.5608{% endif %},
        "hostTeam": "{{ kitchen.host_team.name|escapejs }}",
        "maxTeams": {{ kitchen.max_teams }},
        "currentTeams": {{ kitchen.current_teams_count }},
        "availableCourses": {{ kitchen.available_courses|safe|default:"[]" }},
        "address": "{{ kitchen.address|escapejs }}"
    }{% if not forloop.last %},{% endif %}
{% endfor %}
];

// Afterparty-Daten
const afterpartyData = {% if event.after_party %}{
    "name": "{{ event.after_party.name|escapejs }}",
    "lat": {% if event.after_party.latitude %}{{ event.after_party.latitude|unlocalize }}{% else %}48.1351{% endif %},
    "lng": {% if event.after_party.longitude %}{{ event.after_party.longitude|unlocalize }}{% else %}11.5820{% endif %},
    "startTime": "{{ event.after_party.start_time|time:'H:i' }}",
    "address": "{{ event.after_party.address|escapejs }}",
    "description": "{{ event.after_party.description|escapejs }}"
}{% else %}null{% endif %};

function initMap() {
    // Initialisiere Karte
    if (map) {
        map.remove();
    }
    
    map = L.map('map-container').setView([48.1351, 11.5820], 12);
    
    // OpenStreetMap Tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Marker-Icons f√ºr verschiedene Kurse
    const courseColors = {
        'appetizer': '#e74c3c',
        'main_course': '#f39c12', 
        'dessert': '#27ae60',
        'guest': '#3498db'
    };
    
    // L√∂sche bestehende Marker
    teamMarkers.forEach(marker => map.removeLayer(marker));
    teamMarkers = [];
    
    // Team-Marker hinzuf√ºgen
    teamData.forEach(team => {
        const color = courseColors[team.course] || courseColors['guest'];
        
        // Custom Marker Icon
        const markerIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                background-color: ${color};
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            "></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        const marker = L.marker([team.lat, team.lng], { icon: markerIcon })
            .addTo(map);
        
        // Popup-Inhalt
        const courseNames = {
            'appetizer': 'Vorspeise',
            'main_course': 'Hauptgang',
            'dessert': 'Nachspeise'
        };
        
        const popupContent = `
            <div class="p-2">
                <h6 class="mb-2">${team.name}</h6>
                <p class="mb-1 small">${team.address}</p>
                <p class="mb-1"><strong>Hostet:</strong> ${courseNames[team.course]}</p>
                <p class="mb-1"><strong>Gesamtentfernung:</strong> ${team.totalDistance} km</p>
                <p class="mb-0"><strong>Pr√§ferenz-Score:</strong> ${team.preferenceScore}%</p>
                <hr class="my-2">
                <div class="small">
                    <div><strong>Route:</strong></div>
                    <div>üç∏ Vorspeise: ${team.hosts.appetizer || 'Selbst hosting'}</div>
                    <div>üçΩÔ∏è Hauptgang: ${team.hosts.main_course || 'Selbst hosting'}</div>
                    <div>üç∞ Nachspeise: ${team.hosts.dessert || 'Selbst hosting'}</div>
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        
        // Label hinzuf√ºgen (wenn aktiviert)
        if (document.getElementById('showLabels').checked) {
            const label = L.divIcon({
                className: 'team-label',
                html: `<div style="
                    background-color: rgba(255,255,255,0.9);
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-size: 12px;
                    font-weight: bold;
                    border: 1px solid ${color};
                    color: ${color};
                    white-space: nowrap;
                ">${team.name}</div>`,
                iconSize: [0, 0],
                iconAnchor: [0, -25]
            });
            
            L.marker([team.lat, team.lng], { icon: label }).addTo(map);
        }
        
        teamMarkers.push(marker);
    });
    
    // Gastk√ºchen-Marker hinzuf√ºgen
    guestKitchensData.forEach(kitchen => {
        const kitchenIcon = L.divIcon({
            className: 'kitchen-marker',
            html: `<div style="
                background-color: #8e44ad;
                width: 25px;
                height: 25px;
                border-radius: 4px;
                border: 2px solid white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 12px;
                font-weight: bold;
            ">üè†</div>`,
            iconSize: [25, 25],
            iconAnchor: [12, 12]
        });
        
        const marker = L.marker([kitchen.lat, kitchen.lng], { icon: kitchenIcon }).addTo(map);
        
        const coursesText = kitchen.availableCourses.length ? 
            kitchen.availableCourses.map(c => 
                c === 'appetizer' ? 'Vorspeise' : 
                c === 'main_course' ? 'Hauptgang' : 'Nachspeise'
            ).join(', ') : 'Alle Kurse';
        
        const popupContent = `
            <strong>üè† ${kitchen.name}</strong><br>
            <strong>Gastgeber:</strong> ${kitchen.hostTeam}<br>
            <strong>Kapazit√§t:</strong> ${kitchen.currentTeams}/${kitchen.maxTeams} Teams<br>
            <strong>Verf√ºgbare Kurse:</strong> ${coursesText}<br>
            <strong>Adresse:</strong> ${kitchen.address}
        `;
        marker.bindPopup(popupContent);
        
        teamMarkers.push(marker);
    });
    
    // Afterparty-Marker hinzuf√ºgen
    if (afterpartyData) {
        const afterpartyIcon = L.divIcon({
            className: 'afterparty-marker',
            html: `<div style="
                background-color: #e74c3c;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 3px 8px rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 14px;
                font-weight: bold;
            ">üéâ</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const marker = L.marker([afterpartyData.lat, afterpartyData.lng], { icon: afterpartyIcon }).addTo(map);
        
        const popupContent = `
            <strong>üéâ ${afterpartyData.name}</strong><br>
            <strong>Start:</strong> ${afterpartyData.startTime} Uhr<br>
            <strong>Adresse:</strong> ${afterpartyData.address}<br>
            ${afterpartyData.description ? `<strong>Beschreibung:</strong> ${afterpartyData.description}` : ''}
        `;
        marker.bindPopup(popupContent);
        
        teamMarkers.push(marker);
    }
    
    // Routen zeichnen (wenn aktiviert)
    if (document.getElementById('showRoutes').checked) {
        drawRoutes();
    }
    
    // Statistiken aktualisieren
    updateMapStats();
}

function drawRoutes() {
    // L√∂sche bestehende Routen
    routeLines.forEach(line => map.removeLayer(line));
    routeLines = [];
    
    const courseColors = {
        'appetizer': '#e74c3c',
        'main_course': '#f39c12', 
        'dessert': '#27ae60'
    };
    
    // Zeichne Routen f√ºr jedes Team
    teamData.forEach(team => {
        // Verfolge die Route: Home ‚Üí Vorspeise ‚Üí Hauptgang ‚Üí Nachspeise
        let currentLocation = {lat: team.lat, lng: team.lng, name: team.name};
        
        ['appetizer', 'main_course', 'dessert'].forEach(course => {
            if (team.hosts[course] && team.course !== course) {
                // Finde Host-Team
                const hostTeam = teamData.find(t => t.name === team.hosts[course]);
                if (hostTeam) {
                    const nextLocation = {lat: hostTeam.lat, lng: hostTeam.lng, name: hostTeam.name};
                    
                    // Lade echte Route-Geometrie
                    loadRouteGeometry(currentLocation, nextLocation, courseColors[course]);
                    
                    // Update aktuelle Position f√ºr n√§chsten Gang
                    currentLocation = nextLocation;
                }
            } else if (team.course === course) {
                // Team hostet diesen Gang - bleibt zuhause (reset zu Home)
                currentLocation = {lat: team.lat, lng: team.lng, name: team.name};
            }
        });
    });
}

async function loadRouteGeometry(start, end, color) {
    try {
        // Baue API-URL f√ºr Route-Geometrie
        const eventId = {{ event.id }};
        const url = `/events/${eventId}/route-geometry/?start_lat=${start.lat}&start_lng=${start.lng}&end_lat=${end.lat}&end_lng=${end.lng}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.route_points && data.route_points.length > 0) {
            // Zeichne echte Route mit vielen Punkten
            const line = L.polyline(data.route_points, {
                color: color,
                weight: 3,
                opacity: 0.8,
                smoothFactor: 1.0
            }).addTo(map);
            
            // Popup mit Route-Info
            line.bindPopup(`
                <div class="small">
                    <strong>Route:</strong> ${start.name} ‚Üí ${end.name}<br>
                    <strong>Punkte:</strong> ${data.point_count}<br>
                    <em>Echte Fu√üg√§nger-Route</em>
                </div>
            `);
            
            routeLines.push(line);
        } else {
            // Fallback: Gerade Linie bei API-Fehler
            console.warn('Route-API Fehler, verwende Luftlinie:', data.error || 'Unbekannt');
            drawStraightLine(start, end, color);
        }
    } catch (error) {
        console.error('Route-Laden fehlgeschlagen:', error);
        // Fallback: Gerade Linie
        drawStraightLine(start, end, color);
    }
}

function drawStraightLine(start, end, color) {
    // Fallback: Einfache gerade Linie
    const line = L.polyline([
        [start.lat, start.lng],
        [end.lat, end.lng]
    ], {
        color: color,
        weight: 2,
        opacity: 0.7,
        dashArray: '5, 5'
    }).addTo(map);
    
    line.bindPopup(`
        <div class="small">
            <strong>Route:</strong> ${start.name} ‚Üí ${end.name}<br>
            <em>Luftlinie (Route-API nicht verf√ºgbar)</em>
        </div>
    `);
    
    routeLines.push(line);
}

function updateMapStats() {
    const distances = teamData.map(team => team.totalDistance).filter(d => d > 0);
    const maxDistance = Math.max(...distances);
    document.getElementById('max-distance').textContent = `${maxDistance} km`;
}

// Event-Listener f√ºr Karten-Steuerung
document.getElementById('showRoutes').addEventListener('change', function() {
    if (this.checked) {
        drawRoutes();
    } else {
        routeLines.forEach(line => map.removeLayer(line));
        routeLines = [];
    }
});

document.getElementById('showLabels').addEventListener('change', function() {
    initMap(); // Neu initialisieren um Labels zu aktualisieren
});

// Debug: Team-Daten ausgeben
console.log('Team Data:', teamData);

// Initialisiere Karte wenn Tab geklickt wird
document.getElementById('map-tab').addEventListener('shown.bs.tab', function() {
    setTimeout(() => {
        try {
            initMap();
            if (map) {
                map.invalidateSize();
            }
        } catch (error) {
            console.error('Fehler beim Initialisieren der Karte:', error);
            document.getElementById('map-container').innerHTML = '<div class="alert alert-warning m-3">Fehler beim Laden der Karte: ' + error.message + '</div>';
        }
    }, 100);
});

// Initialisiere bei Seitenladung falls Tab bereits aktiv
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('map-tab').classList.contains('active')) {
        setTimeout(initMap, 500);
    }
});

// Progress-Tracking Funktionen
let progressInterval = null;

function toggleProgressView() {
    const progressSection = document.getElementById('progressSection');
    if (progressSection.style.display === 'none') {
        progressSection.style.display = 'block';
        startProgressTracking();
    } else {
        progressSection.style.display = 'none';
        stopProgressTracking();
    }
}

function startProgressTracking() {
    // Sofort einmal laden
    updateProgress();
    
    // Dann alle 2 Sekunden aktualisieren
    progressInterval = setInterval(updateProgress, 2000);
}

function stopProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
}

async function updateProgress() {
    try {
        const response = await fetch(`/events/{{ event.id }}/optimization-progress/`);
        const data = await response.json();
        
        if (data.success) {
            // Update Progress Bar
            const progressBar = document.getElementById('progressBar');
            const currentTask = document.getElementById('currentTask');
            
            progressBar.style.width = data.progress.percentage + '%';
            progressBar.setAttribute('aria-valuenow', data.progress.percentage);
            progressBar.textContent = data.progress.percentage + '%';
            currentTask.textContent = data.progress.current_task;
            
            // Update Progress Bar color based on status
            progressBar.className = 'progress-bar progress-bar-striped';
            if (data.progress.status === 'running') {
                progressBar.className += ' progress-bar-animated bg-primary';
            } else if (data.progress.status === 'completed') {
                progressBar.className += ' bg-success';
            } else {
                progressBar.className += ' bg-secondary';
            }
            
            // Update Logs
            const logsContainer = document.getElementById('optimizationLogs');
            if (data.logs && data.logs.length > 0) {
                logsContainer.innerHTML = data.logs.map(log => 
                    `<div><span class="text-primary">[${log.timestamp}]</span> ${log.message}</div>`
                ).join('');
                // Auto-scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // Stoppe Tracking wenn abgeschlossen
            if (data.progress.status === 'completed') {
                setTimeout(stopProgressTracking, 5000); // Stoppe nach 5 Sekunden
            }
        }
    } catch (error) {
        console.error('Progress-Update fehlgeschlagen:', error);
    }
}

</script>

<!-- Modal f√ºr weitere Optimierung -->
<div class="modal fade" id="additionalOptimizationModal" tabindex="-1" aria-labelledby="additionalOptimizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="additionalOptimizationModalLabel">üîÑ Weitere Optimierung</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'events:run_additional_optimization' event.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted">
                        F√ºhre weitere Optimierungsiterationen durch, um die G√§steverteilung und Distanzen weiter zu verbessern.
                    </p>
                    
                    <div class="mb-3">
                        <label for="additional_iterations" class="form-label">Anzahl zus√§tzlicher Iterationen:</label>
                        <select class="form-select" id="additional_iterations" name="additional_iterations">
                            <option value="3">3 Iterationen (schnell)</option>
                            <option value="5" selected>5 Iterationen (empfohlen)</option>
                            <option value="8">8 Iterationen (gr√ºndlich)</option>
                            <option value="10">10 Iterationen (maximum)</option>
                        </select>
                        <div class="form-text">
                            Mehr Iterationen = bessere Optimierung, aber l√§ngere Laufzeit
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üí° Tipp:</strong> Die Optimierung priorisiert jetzt <strong>gleichm√§√üige G√§steverteilung</strong> 
                        √ºber minimale Distanzen. Sie k√∂nnen den Progress oben verfolgen.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">üîÑ Optimierung starten</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
