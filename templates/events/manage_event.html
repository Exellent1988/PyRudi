{% extends 'base.html' %}
{% load l10n %}

{% block title %}{{ event.name }} verwalten - Running Dinner{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'events:organizer_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">{{ event.name }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold">{{ event.name }}</h1>
                    <p class="lead text-muted">Event-Management</p>
                </div>
                <div>
                    <span class="badge bg-primary fs-6 me-2">{{ event.get_status_display }}</span>
                    <span class="badge bg-secondary fs-6">{{ user_role|title }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body text-center">
                    <h3 class="fw-bold">{{ stats.confirmed_teams }}</h3>
                    <small>Best√§tigte Teams</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 class="fw-bold">{{ stats.pending_teams }}</h3>
                    <small>Wartende Teams</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white">
                <div class="card-body text-center">
                    <h3 class="fw-bold">{{ stats.total_participants }}</h3>
                    <small>Teilnehmer</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm {% if stats.critical_allergies_count > 0 %}bg-danger text-white{% else %}bg-secondary text-white{% endif %}">
                <div class="card-body text-center">
                    <h3 class="fw-bold">{{ stats.critical_allergies_count }}</h3>
                    <small>Kritische Allergien</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Anmelde-Fortschritt</h6>
                        <span class="text-muted">{{ stats.confirmed_teams }} / {{ event.max_teams }} Teams</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: {{ stats.registration_progress }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Team Registrations -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people text-primary"></i>
                        Team-Anmeldungen
                    </h5>
                </div>
                <div class="card-body">
                    {% if registrations %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>Mitglieder</th>
                                    <th>Status</th>
                                    <th>Allergien</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in registrations %}
                                <tr>
                                    <td>
                                        <div>
                                            <h6 class="mb-1">{{ registration.team.name }}</h6>
                                            <small class="text-muted">
                                                Angemeldet: {{ registration.registered_at|date:"d.m.Y H:i" }}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="mb-1">
                                            <span class="fw-bold">{{ registration.team.member_count }}</span> Personen
                                            {% if registration.team.member_count < registration.team.max_members %}
                                            <small class="text-warning">‚ö†Ô∏è Nicht vollst√§ndig</small>
                                            {% endif %}
                                        </div>
                                        <div class="small text-muted">
                                            {% for membership in registration.team.members_with_roles %}
                                                <span 
                                                    {% if membership.role == 'leader' %}class="fw-bold member-name"{% else %}class="member-name"{% endif %}
                                                    data-bs-toggle="tooltip" 
                                                    data-bs-placement="top"
                                                    data-bs-html="true"
                                                    data-email="{{ membership.user.email }}"
                                                    title="<strong>{{ membership.user.full_name }}</strong><br>
                                                           <i class='bi bi-envelope'></i> {{ membership.user.email }}<br>
                                                           {% if membership.user.phone_number %}<i class='bi bi-telephone'></i> {{ membership.user.phone_number }}<br>{% endif %}
                                                           <i class='bi bi-person-badge'></i> {{ membership.get_role_display }}<br>
                                                           <i class='bi bi-calendar'></i> Seit {{ membership.joined_at|date:'d.m.Y' }}<br>
                                                           <small style='color: #ffc107;'>üí° Klick zum E-Mail kopieren</small>"
                                                    style="cursor: pointer; text-decoration: underline;">
                                                    {{ membership.user.full_name }}{% if membership.role == 'leader' %} üëë{% endif %}
                                                </span>{% if not forloop.last %}, {% endif %}
                                            {% empty %}
                                                <em>Keine Mitglieder</em>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if registration.status == 'confirmed' %}
                                        <span class="badge bg-success">{{ registration.get_status_display }}</span>
                                        {% elif registration.status == 'pending' %}
                                        <span class="badge bg-warning">{{ registration.get_status_display }}</span>
                                        {% elif registration.status == 'waiting_list' %}
                                        <span class="badge bg-info">{{ registration.get_status_display }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ registration.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if registration.team.critical_team_allergies.exists %}
                                        <span class="text-danger">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                            {{ registration.team.critical_team_allergies.count }} kritisch
                                        </span>
                                        {% elif registration.team.team_dietary_restrictions.exists %}
                                        <span class="text-warning">
                                            <i class="bi bi-info-circle"></i>
                                            {{ registration.team.team_dietary_restrictions.count }} Einschr√§nkungen
                                        </span>
                                        {% else %}
                                        <span class="text-success">
                                            <i class="bi bi-check-circle"></i> Keine
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user_can_manage_teams %}
                                        <div class="dropdown">
                                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <form method="post" action="{% url 'events:update_team_status' event_id=event.id registration_id=registration.id %}">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="status" value="confirmed">
                                                        <button type="submit" class="dropdown-item text-success">
                                                            <i class="bi bi-check"></i> Best√§tigen
                                                        </button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form method="post" action="{% url 'events:update_team_status' event_id=event.id registration_id=registration.id %}">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="status" value="waiting_list">
                                                        <button type="submit" class="dropdown-item text-warning">
                                                            <i class="bi bi-clock"></i> Warteliste
                                                        </button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form method="post" action="{% url 'events:update_team_status' event_id=event.id registration_id=registration.id %}">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="status" value="rejected">
                                                        <button type="submit" class="dropdown-item text-danger">
                                                            <i class="bi bi-x"></i> Ablehnen
                                                        </button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                        <h6 class="mt-3 text-muted">Noch keine Anmeldungen</h6>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Event Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightning text-warning"></i>
                        Aktionen
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if user_can_run_optimization %}
                        <form method="post" action="{% url 'events:start_optimization' event_id=event.id %}" onsubmit="return handleOptimizationStart(event);" id="optimizationForm">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success w-100" id="optimizationButton">
                                <i class="bi bi-cpu"></i> Optimierung starten
                            </button>
                        </form>
                        
                        <!-- Debug Info -->
                        <div id="debugInfo" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <small>üîß Debug: <span id="debugMessage">Initialisiert...</span></small>
                            </div>
                        </div>
                        
                        <!-- Live Progress Bar -->
                        <div id="optimizationProgress" style="display: none;" class="mt-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-gear-fill rotate"></i> Optimierung l√§uft...
                                    </h6>
                                    
                                    <!-- Progress Bar -->
                                    <div class="progress mb-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             id="progressBar"
                                             style="width: 0%"
                                             aria-valuenow="0" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            <span id="progressText">0%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Task -->
                                    <div class="mb-3">
                                        <strong>Aktueller Schritt:</strong>
                                        <span id="currentTask">Starte Optimierung...</span>
                                    </div>
                                    
                                    <!-- Collapsible Log -->
                                    <div class="accordion" id="logAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="logHeading">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#logCollapse" 
                                                        aria-expanded="false" aria-controls="logCollapse">
                                                    <i class="bi bi-terminal"></i>&nbsp; Detaillierte Logs anzeigen
                                                </button>
                                            </h2>
                                            <div id="logCollapse" class="accordion-collapse collapse" 
                                                 aria-labelledby="logHeading" data-bs-parent="#logAccordion">
                                                <div class="accordion-body">
                                                    <pre id="optimizationLog" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.85em;">Warte auf Logs...</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if event.status == 'optimized' %}
                        <a href="{% url 'events:optimization_results' event_id=event.id %}" class="btn btn-info">
                            <i class="bi bi-diagram-3"></i> Ergebnisse anzeigen
                        </a>
                        {% endif %}
                        
                        <!-- Gastk√ºchen Button -->
                        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#guestKitchensModal">
                            <i class="bi bi-house-door"></i> Gastk√ºchen verwalten
                        </button>
                        
                        <!-- Afterparty Button -->
                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#afterpartyModal">
                            <i class="bi bi-music-note-beamed"></i> Afterparty konfigurieren
                        </button>
                        
                        <a href="{% url 'events:event_detail' event_id=event.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-eye"></i> Event anzeigen
                        </a>
                        
                        {% if user_role == 'main_organizer' %}
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editEventModal">
                            <i class="bi bi-pencil"></i> Event bearbeiten
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Organizers -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-person-gear text-info"></i>
                            Organisatoren
                        </h6>
                        {% if user_role == 'main_organizer' %}
                        <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#inviteOrganizerModal">
                            <i class="bi bi-plus"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Haupt-Organisator -->
                    <div class="d-flex align-items-center mb-3 p-2 bg-warning bg-opacity-10 rounded">
                        <i class="bi bi-star-fill text-warning me-3"></i>
                        <div>
                            <h6 class="mb-0">{{ event.organizer.full_name }}</h6>
                            <small class="text-muted">Haupt-Organisator</small>
                        </div>
                    </div>
                    
                    <!-- Co-Organisatoren -->
                    {% for organizer in organizers %}
                    <div class="d-flex align-items-center mb-2 p-2 border rounded">
                        <i class="bi bi-person-check text-primary me-3"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">{{ organizer.user.full_name }}</h6>
                            <small class="text-muted">{{ organizer.get_role_display }}</small>
                        </div>
                        {% if user_role == 'main_organizer' %}
                        <form method="post" action="{% url 'events:remove_organizer' event_id=event.id organizer_id=organizer.id %}" class="ms-2" onsubmit="return confirm('Sind Sie sicher, dass Sie {{ organizer.user.full_name }} als Organisator entfernen m√∂chten?')">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Critical Allergies Alert -->
            {% if critical_allergies %}
            <div class="card border-0 shadow-sm border-danger">
                <div class="card-header bg-danger text-white py-3">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Kritische Allergien
                    </h6>
                </div>
                <div class="card-body">
                    {% for allergy_info in critical_allergies %}
                    <div class="alert alert-danger py-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>{{ allergy_info.member }}</strong>
                            <span class="badge bg-light text-dark">{{ allergy_info.team_name }}</span>
                        </div>
                        {% for allergy in allergy_info.allergies %}
                        <div class="small">
                            <strong>{{ allergy.name }}</strong> ({{ allergy.severity }})
                            {% if allergy.emergency_info %}
                            <br>‚ö†Ô∏è {{ allergy.emergency_info }}
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% if allergy_info.emergency_phone %}
                        <div class="small mt-1">
                            üìû Notfall: {{ allergy_info.emergency_phone }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'events:update_event' event_id=event.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="edit_name" class="form-label">Event-Name</label>
                            <input type="text" class="form-control" id="edit_name" name="name" value="{{ event.name }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_city" class="form-label">Stadt</label>
                            <input type="text" class="form-control" id="edit_city" name="city" value="{{ event.city }}" required>
                        </div>
                        <div class="col-12">
                            <label for="edit_description" class="form-label">Beschreibung</label>
                            <textarea class="form-control" id="edit_description" name="description" rows="3">{{ event.description }}</textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_event_date" class="form-label">Event-Datum</label>
                            <input type="date" class="form-control" id="edit_event_date" name="event_date" value="{{ event.event_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_max_teams" class="form-label">Max. Teams</label>
                            <input type="number" class="form-control" id="edit_max_teams" name="max_teams" value="{{ event.max_teams|unlocalize }}" min="3" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_price" class="form-label">Preis pro Person (‚Ç¨)</label>
                            <input type="number" class="form-control" id="edit_price" name="price_per_person" value="{{ event.price_per_person|unlocalize }}" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_appetizer_time" class="form-label">Vorspeise Zeit</label>
                            <input type="time" class="form-control" id="edit_appetizer_time" name="appetizer_time" value="{{ event.appetizer_time|time:'H:i' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_main_time" class="form-label">Hauptgang Zeit</label>
                            <input type="time" class="form-control" id="edit_main_time" name="main_course_time" value="{{ event.main_course_time|time:'H:i' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="edit_dessert_time" class="form-label">Nachspeise Zeit</label>
                            <input type="time" class="form-control" id="edit_dessert_time" name="dessert_time" value="{{ event.dessert_time|time:'H:i' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_status" class="form-label">Status</label>
                            <select class="form-select" id="edit_status" name="status">
                                <option value="planning" {% if event.status == 'planning' %}selected{% endif %}>Planung</option>
                                <option value="registration_open" {% if event.status == 'registration_open' %}selected{% endif %}>Anmeldung ge√∂ffnet</option>
                                <option value="registration_closed" {% if event.status == 'registration_closed' %}selected{% endif %}>Anmeldung geschlossen</option>
                                <option value="optimized" {% if event.status == 'optimized' %}selected{% endif %}>Optimiert</option>
                                <option value="in_progress" {% if event.status == 'in_progress' %}selected{% endif %}>L√§uft</option>
                                <option value="completed" {% if event.status == 'completed' %}selected{% endif %}>Abgeschlossen</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="edit_is_public" name="is_public" {% if event.is_public %}checked{% endif %}>
                                <label class="form-check-label" for="edit_is_public">
                                    √ñffentlich sichtbar
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invite Organizer Modal -->
<div class="modal fade" id="inviteOrganizerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Co-Organisator einladen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'events:invite_organizer' event_id=event.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="email" class="form-label">E-Mail Adresse</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Rolle</label>
                        <select class="form-select" id="role" name="role">
                            <option value="assistant">Assistent</option>
                            <option value="moderator">Moderator</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Berechtigungen</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="manage_teams" id="perm_teams">
                            <label class="form-check-label" for="perm_teams">Teams verwalten</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="edit_event" id="perm_edit">
                            <label class="form-check-label" for="perm_edit">Event bearbeiten</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="run_optimization" id="perm_opt">
                            <label class="form-check-label" for="perm_opt">Optimierung starten</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Einladen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Gastk√ºchen Modal -->
<div class="modal fade" id="guestKitchensModal" tabindex="-1" aria-labelledby="guestKitchensModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guestKitchensModalLabel">üè† Gastk√ºchen verwalten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs f√ºr verschiedene Bereiche -->
                <ul class="nav nav-tabs" id="guestKitchenTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="guest-kitchens-tab" data-bs-toggle="tab" data-bs-target="#guest-kitchens" 
                                type="button" role="tab" aria-controls="guest-kitchens" aria-selected="true">
                            üè† Gastk√ºchen
                        </button>
                    </li>

                </ul>
                
                <div class="tab-content" id="guestKitchenTabsContent">
                    <!-- Gastk√ºchen Tab -->
                    <div class="tab-pane fade show active" id="guest-kitchens" role="tabpanel" aria-labelledby="guest-kitchens-tab">
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6>Verf√ºgbare Gastk√ºchen</h6>
                                    <button class="btn btn-sm btn-primary" onclick="showAddGuestKitchenForm()">
                                        <i class="bi bi-plus"></i> Gastk√ºche hinzuf√ºgen
                                    </button>
                                </div>
                                
                                <!-- Gastk√ºchen Liste -->
                                <div id="guestKitchensList">
                                    <div class="text-muted text-center py-3">
                                        <i class="bi bi-house-door display-4"></i>
                                        <p>Lade Gastk√ºchen...</p>
                                    </div>
                                </div>
                                
                                <!-- Gastk√ºche hinzuf√ºgen Form (initially hidden) -->
                                <div id="addGuestKitchenForm" style="display: none;" class="border rounded p-3 mt-3">
                                    <h6>Neue Gastk√ºche hinzuf√ºgen</h6>
                                    <form id="guestKitchenForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Name der Gastk√ºche</label>
                                                <input type="text" class="form-control" name="name" placeholder="z.B. K√ºche bei Familie Schmidt" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Gastgeber-Team</label>
                                                <select class="form-select" name="host_team" required>
                                                    <option value="">Team ausw√§hlen...</option>
                                                    <!-- Teams werden dynamisch geladen -->
                                                </select>
                                            </div>
                                            <div class="col-12 mt-2">
                                                <label class="form-label">Adresse</label>
                                                <textarea class="form-control" name="address" rows="2" placeholder="Vollst√§ndige Adresse" required></textarea>
                                            </div>
                                            <div class="col-md-4 mt-2">
                                                <label class="form-label">Max. Teams</label>
                                                <input type="number" class="form-control" name="max_teams" value="3" min="1" max="10" required>
                                            </div>
                                            <div class="col-md-8 mt-2">
                                                <label class="form-label">Verf√ºgbare Kurse</label>
                                                <div class="form-check-group d-flex gap-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="available_courses" value="appetizer" id="course_appetizer">
                                                        <label class="form-check-label" for="course_appetizer">Vorspeise</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="available_courses" value="main_course" id="course_main">
                                                        <label class="form-check-label" for="course_main">Hauptgang</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="available_courses" value="dessert" id="course_dessert">
                                                        <label class="form-check-label" for="course_dessert">Nachspeise</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12 mt-2">
                                                <label class="form-label">Notizen (optional)</label>
                                                <textarea class="form-control" name="notes" rows="2" placeholder="Zus√§tzliche Informationen zur K√ºche"></textarea>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-check"></i> Gastk√ºche speichern
                                            </button>
                                            <button type="button" class="btn btn-secondary ms-2" onclick="hideAddGuestKitchenForm()">
                                                Abbrechen
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Afterparty Modal -->
<div class="modal fade" id="afterpartyModal" tabindex="-1" aria-labelledby="afterpartyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="afterpartyModalLabel">
                    üéâ Aftershow-Party konfigurieren
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Aktuelle Afterparty anzeigen -->
                <div id="currentAfterParty" class="mb-4" style="display: none;">
                    <div class="alert alert-success">
                        <strong>üéâ Aktuelle Afterparty:</strong>
                        <div id="afterPartyDetails"></div>
                        <hr class="my-2">
                        <small class="text-muted">Bearbeiten Sie die Felder unten, um √Ñnderungen vorzunehmen.</small>
                    </div>
                </div>
                
                <!-- Afterparty Form -->
                <form id="afterPartyForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Name der Location</label>
                            <input type="text" class="form-control" name="name" placeholder="z.B. Bar Centrale" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Beginn</label>
                            <input type="time" class="form-control" name="start_time" value="22:30" required>
                        </div>
                        <div class="col-12 mt-3">
                            <label class="form-label">Adresse</label>
                            <textarea class="form-control" name="address" rows="2" placeholder="Vollst√§ndige Adresse der Location" required></textarea>
                        </div>
                        <div class="col-12 mt-3">
                            <label class="form-label">Beschreibung</label>
                            <textarea class="form-control" name="description" rows="3" 
                                      placeholder="Was erwartet die Teams dort? Live-Musik, Getr√§nke, etc."></textarea>
                        </div>
                        <div class="col-12 mt-3">
                            <label class="form-label">Kontakt-Info</label>
                            <input type="text" class="form-control" name="contact_info" 
                                   placeholder="Telefon, Website, etc.">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Abbrechen
                </button>
                <button type="submit" form="afterPartyForm" class="btn btn-success">
                    <i class="bi bi-check"></i> Afterparty speichern
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript f√ºr Gastk√ºchen & Afterparty Management
function showAddGuestKitchenForm() {
    document.getElementById('addGuestKitchenForm').style.display = 'block';
    loadTeamsForGuestKitchen();
}

function hideAddGuestKitchenForm() {
    document.getElementById('addGuestKitchenForm').style.display = 'none';
}

function loadTeamsForGuestKitchen() {
    // TODO: Teams √ºber AJAX laden
    console.log('Loading teams for guest kitchen...');
}

function loadGuestKitchens() {
    // TODO: Gastk√ºchen √ºber AJAX laden
    console.log('Loading guest kitchens...');
}

function loadAfterParty() {
    // Lade bestehende Afterparty-Daten
    console.log('üéâ Loading afterparty for event:', {{ event.id|unlocalize }});
    fetch(`/events/{{ event.id|unlocalize }}/get-afterparty/`)
        .then(response => {
            console.log('üì° Get Afterparty Response Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Get Afterparty Data:', data);
            if (data.success && data.afterparty) {
                // F√ºlle Form mit bestehenden Daten
                const form = document.getElementById('afterPartyForm');
                form.name.value = data.afterparty.name || '';
                form.start_time.value = data.afterparty.start_time || '22:30';
                form.address.value = data.afterparty.address || '';
                form.description.value = data.afterparty.description || '';
                form.contact_info.value = data.afterparty.contact_info || '';
                
                // Zeige aktuelle Afterparty an
                showCurrentAfterParty(data.afterparty);
            }
        })
        .catch(error => {
            console.error('Error loading after party:', error);
        });
}

function showCurrentAfterParty(afterparty) {
    const currentDiv = document.getElementById('currentAfterParty');
    const detailsDiv = document.getElementById('afterPartyDetails');
    
    detailsDiv.innerHTML = `
        <strong>${afterparty.name}</strong><br>
        <strong>Start:</strong> ${afterparty.start_time} Uhr<br>
        <strong>Adresse:</strong> ${afterparty.address}<br>
        ${afterparty.description ? `<strong>Beschreibung:</strong> ${afterparty.description}<br>` : ''}
        ${afterparty.contact_info ? `<strong>Kontakt:</strong> ${afterparty.contact_info}` : ''}
    `;
    
    currentDiv.style.display = 'block';
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Modal Event Listeners
    const guestKitchensModal = document.getElementById('guestKitchensModal');
    guestKitchensModal.addEventListener('shown.bs.modal', function () {
        loadGuestKitchens();
    });
    
    // Afterparty Modal Event Handler
    const afterpartyModal = document.getElementById('afterpartyModal');
    afterpartyModal.addEventListener('shown.bs.modal', function () {
        loadAfterParty();
    });
    
    // Afterparty Form Handler
    const afterPartyForm = document.getElementById('afterPartyForm');
    afterPartyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        console.log('üéâ Saving afterparty for event:', {{ event.id|unlocalize }});
        const formData = new FormData(afterPartyForm);
        
        // Debug FormData
        for (let [key, value] of formData.entries()) {
            console.log('üìù Form Data:', key, '=', value);
        }
        
                                fetch(`/events/{{ event.id|unlocalize }}/save-afterparty/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log('üì° Afterparty Save Response Status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text().then(text => {
                console.log('üì° Afterparty Raw Response:', text);
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('‚ùå JSON Parse Error:', e, 'Raw:', text);
                    throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
                }
            });
        })
        .then(data => {
            if (data.success) {
                // Zeige Erfolg
                showCurrentAfterParty(data.afterparty);
                
                // Bootstrap Alert
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    ‚úÖ Afterparty erfolgreich gespeichert!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                afterPartyForm.appendChild(alertDiv);
                
                // Auto-remove nach 3 Sekunden
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            } else {
                // Zeige Fehler
                alert('Fehler beim Speichern: ' + (data.error || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Error saving after party:', error);
            
            // Zeige detaillierten Fehler
            const errorMsg = error.message || 'Unbekannter Fehler';
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                ‚ùå Fehler beim Speichern: ${errorMsg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            afterPartyForm.appendChild(alertDiv);
            
            // Auto-remove nach 5 Sekunden
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        });
    });

// Live Optimization Progress Tracking - Global Scope
let optimizationTimer = null;
const eventId = {{ event.id|unlocalize }};

function showDebugMessage(message) {
    /*const debugDiv = document.getElementById('debugInfo');
    const debugMessage = document.getElementById('debugMessage');
    
    if (debugDiv && debugMessage) {
        debugDiv.style.display = 'block';
        debugMessage.textContent = message;
        console.log('üîß DEBUG:', message);
        
        // Auto-hide nach 5 Sekunden
        setTimeout(() => {
            if (debugDiv) debugDiv.style.display = 'none';
        }, 5000);
    }
        */
}

function handleOptimizationStart(event) {
    console.log('üöÄ Form submission intercepted for event ID:', eventId);
    
    // Verhindere Standard-Submit f√ºr Debug-Zwecke
    event.preventDefault();
    
    // Zeige Progress Bar
    startOptimization();
    
    // Sende Form programmatisch ab nach kurzem Delay
    setTimeout(() => {
        console.log('üì§ Submitting form programmatically...');
        const form = document.getElementById('optimizationForm');
        if (form) {
            // Entferne onsubmit um Rekursion zu vermeiden
            form.onsubmit = null;
            form.submit();
        }
    }, 500);
    
    return false; // Verhindere Standard-Submit
}

function startOptimization() {
    showDebugMessage('Starte Optimierung UI...');
    console.log('üöÄ Starting optimization UI for event ID:', eventId);
    
    // Zeige Progress Bar
    const progressDiv = document.getElementById('optimizationProgress');
    if (progressDiv) {
        progressDiv.style.display = 'block';
        showDebugMessage('Progress Bar angezeigt!');
        console.log('‚úÖ Progress bar shown');
    } else {
        showDebugMessage('‚ùå Progress Bar Element nicht gefunden!');
        console.error('‚ùå Progress bar element not found');
        // Debugge verf√ºgbare Elemente
        const availableIds = Array.from(document.querySelectorAll('[id]')).map(el => el.id);
        console.log('Available elements with IDs:', availableIds);
        showDebugMessage('Verf√ºgbare IDs: ' + availableIds.slice(0, 10).join(', '));
    }
    
    // Deaktiviere Button
    const button = document.getElementById('optimizationButton');
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Optimierung l√§uft...';
        showDebugMessage('Button deaktiviert');
        console.log('‚úÖ Button disabled');
    } else {
        showDebugMessage('‚ùå Optimierung Button nicht gefunden!');
        console.error('‚ùå Optimization button not found');
    }
    
    // Starte Progress-Polling nach kurzer Verz√∂gerung (Server braucht Zeit zum Starten)
    setTimeout(() => {
        showDebugMessage('Starte Progress-Polling...');
        console.log('‚è±Ô∏è Starting progress polling...');
        optimizationTimer = setInterval(updateOptimizationProgress, 2000); // Alle 2 Sekunden
    }, 1000);
}

function updateOptimizationProgress() {
    console.log('üì° Fetching progress for event:', eventId);
    
    fetch(`/events/${eventId}/optimization-progress/`)
        .then(response => {
            console.log('üì° Progress response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Progress data received:', data);
            
            if (data.status === 'completed') {
                // Optimierung abgeschlossen
                console.log('‚úÖ Optimization completed!');
                clearInterval(optimizationTimer);
                
                // Progress auf 100%
                updateProgressBar(100, 'Optimierung abgeschlossen!');
                
                // Success Animation
                const progressBar = document.getElementById('progressBar');
                progressBar.className = 'progress-bar bg-success';
                progressBar.innerHTML = '<i class="bi bi-check-circle"></i> Abgeschlossen!';
                
                // Button wieder aktivieren und umleiten
                setTimeout(() => {
                    window.location.href = `/events/${eventId}/results/`;
                }, 2000);
                
            } else if (data.status === 'error') {
                // Fehler aufgetreten
                clearInterval(optimizationTimer);
                
                const progressBar = document.getElementById('progressBar');
                progressBar.className = 'progress-bar bg-danger';
                progressBar.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Fehler!';
                
                document.getElementById('currentTask').textContent = 'Fehler: ' + (data.error || 'Unbekannter Fehler');
                
                // Button wieder aktivieren
                const button = document.getElementById('optimizationButton');
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-cpu"></i> Optimierung starten';
                
            } else if (data.status === 'running') {
                // Update Progress - sicherere Zahlenkonvertierung
                const safePercentage = parseFloat(String(data.percentage).replace(',', '.')) || 0;
                updateProgressBar(safePercentage, data.current_task);
            }
            
            // Update Logs
            updateOptimizationLogs();
            
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
            // Bei Netzwerkfehlern nicht abbrechen, weiter versuchen
        });
}

function updateProgressBar(percentage, task) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentTask = document.getElementById('currentTask');
    
    // Doppelte Sichere Zahlenformatierung (amerikanisches Format f√ºr HTML)
    let safePercentage = parseFloat(String(percentage).replace(',', '.')) || 0;
    
    console.log('üìä Updating progress bar:', safePercentage + '%', 'Task:', task);
    showDebugMessage(`Progress: ${safePercentage}% - ${task}`);
    
    if (progressBar) {
        progressBar.style.width = safePercentage + '%';
        progressBar.setAttribute('aria-valuenow', safePercentage);
    }
    
    if (progressText) {
        progressText.textContent = Math.round(safePercentage) + '%';
    }
    
    if (currentTask) {
        currentTask.textContent = task;
    }
}

function updateOptimizationLogs() {
    fetch(`/events/${eventId}/optimization-progress/`)
        .then(response => response.json())
        .then(data => {
            if (data.logs && data.logs.length > 0) {
                const logElement = document.getElementById('optimizationLog');
                const logText = data.logs.join('\n');
                
                if (logElement && logElement.textContent !== logText) {
                    logElement.textContent = logText;
                    // Auto-scroll zum Ende
                    logElement.scrollTop = logElement.scrollHeight;
                    console.log('üìù Logs updated, entries:', data.logs.length);
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Error fetching logs:', error);
        });
}

// Initialisierung beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Page loaded, checking elements...');
    showDebugMessage('Seite geladen - Event ID: ' + eventId);
    
    // Pr√ºfe wichtige Elemente
    const elements = [
        'optimizationProgress',
        'progressBar', 
        'progressText',
        'currentTask',
        'optimizationLog',
        'optimizationButton'
    ];
    
    let missingElements = [];
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (!el) {
            missingElements.push(id);
        }
    });
    
    if (missingElements.length > 0) {
        showDebugMessage('‚ö†Ô∏è Fehlende Elemente: ' + missingElements.join(', '));
        console.warn('Missing elements:', missingElements);
    } else {
        showDebugMessage('‚úÖ Alle Progress-Elemente gefunden!');
        console.log('‚úÖ All progress elements found');
    }
    
    // Test-Button hinzuf√ºgen (nur f√ºr Debug)
    if (window.location.search.includes('debug=1')) {
        const debugButton = document.createElement('button');
        debugButton.textContent = 'üß™ Test Progress Bar';
        debugButton.className = 'btn btn-outline-secondary btn-sm mt-2';
        debugButton.onclick = function() {
            startOptimization();
        };
        
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            debugInfo.appendChild(debugButton);
        }
    }
});

// Expose functions globally for debugging
window.startOptimization = startOptimization;
window.updateProgressBar = updateProgressBar;
window.handleOptimizationStart = handleOptimizationStart;
});
</script>

<!-- CSS f√ºr Animation -->
<style>
.rotate {
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            trigger: 'hover focus'
        });
    });
    
    // Handle email copying when clicking on member names
    document.querySelectorAll('.member-name').forEach(function(element) {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const email = this.getAttribute('data-email');
            
            // Copy to clipboard
            navigator.clipboard.writeText(email).then(function() {
                // Show success toast
                showCopyToast(email);
            }).catch(function(err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = email;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyToast(email);
            });
        });
    });
});

// Show copy success toast
function showCopyToast(email) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0';
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle me-2"></i>
                E-Mail kopiert: <strong>${email}</strong>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Initialize and show toast
    const bootstrapToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bootstrapToast.show();
    
    // Remove toast from DOM after it's hidden
    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}
</script>

{% endblock %}
